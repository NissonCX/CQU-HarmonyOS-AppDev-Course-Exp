// MinesweeperRecords.ets
import { router } from '@kit.ArkUI';
import { ThemeManager } from '../model/ThemeManager';
import { ThemeType, ThemeColors } from '../model/Theme';
import { MinesweeperRecord, MinesweeperRecordData, PlayerLevel, getPlayerLevel } from '../model/MinesweeperRecord';
import { MinesweeperStorage } from '../utils/MinesweeperStorage';

@Entry
@Component
struct MinesweeperRecords {
  @State private records: MinesweeperRecord[] = [];
  @State private currentTheme: ThemeType = ThemeManager.getInstance().getCurrentTheme();
  @State private themeColors: ThemeColors = ThemeManager.getInstance().getCurrentColors();
  @State private playerLevel: PlayerLevel | null = PlayerLevel.BEGINNER;
  
  aboutToAppear(): void {
    // ä»æœ¬åœ°å­˜å‚¨æˆ–å…¶ä»–æ–¹å¼åŠ è½½è®°å½•
    this.loadRecords();
    
    // æ·»åŠ ä¸»é¢˜ç›‘å¬å™¨
    ThemeManager.getInstance().addThemeChangeListener((theme: ThemeType, colors: ThemeColors) => {
      this.currentTheme = theme;
      this.themeColors = colors;
    });
  }
  
  private async loadRecords(): Promise<void> {
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®°å½•ï¼ˆç¤ºä¾‹å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼‰
    try {
      const storage = MinesweeperStorage.getInstance();
      const recordsData: MinesweeperRecordData[] = await storage.getRecords();
      this.records = recordsData.map((item) => {
        const record = new MinesweeperRecord(item.time, item.isWin);
        record.id = item.id;
        record.timestamp = item.timestamp;
        return record;
      });
      this.updatePlayerLevel();
    } catch (e) {
      console.error('åŠ è½½æ‰«é›·è®°å½•å¤±è´¥:', e);
      this.records = [];
    }
  }
  
  private updatePlayerLevel(): void {
    const level = getPlayerLevel(this.records.filter(r => r.isWin).length);
    this.playerLevel = level || PlayerLevel.BEGINNER;
  }
  
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }
  
  build() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Column() {
        Row() {
          // è¿”å›æŒ‰é’®
          Button('â†')
            .width(40)
            .height(40)
            .backgroundColor(this.themeColors.buttonBackground)
            .fontColor(this.themeColors.buttonText)
            .borderRadius(20)
            .border({ width: 1, color: this.themeColors.buttonBorder })
            .shadow({
              radius: 4,
              color: this.themeColors.cardShadow,
              offsetX: 1,
              offsetY: 1
            })
            .onClick(() => {
              router.back();
            })
          
          // æ ‡é¢˜åŒºåŸŸ
          Column() {
            Text('ğŸ† æ‰«é›·æˆ˜ç»©')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .textAlign(TextAlign.Center)
              .fontColor(this.themeColors.primaryText)
            
            if (this.playerLevel) {
              Text(`å½“å‰ç­‰çº§: ${this.playerLevel}`)
                .fontSize(16)
                .fontColor(this.themeColors.secondaryText)
                .margin({ top: 6 })
            } else {
              Text('å½“å‰ç­‰çº§: æ— ')
                .fontSize(16)
                .fontColor(this.themeColors.secondaryText)
                .margin({ top: 6 })
            }
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)
          
          // å ä½ç¬¦ä¿æŒå¯¹ç§°
          Column()
            .width(40)
            .height(40)
        }
        .width('100%')
        .padding({ left: 20, right: 20 })
        .margin({ top: 20, bottom: 20 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      
      // ç»Ÿè®¡ä¿¡æ¯
      Row() {
        Column() {
          Text(`${this.records.length}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.themeColors.primaryText)
          Text('æ€»æ¸¸æˆæ¬¡æ•°')
            .fontSize(14)
            .fontColor(this.themeColors.secondaryText)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        
        Column() {
          Text(`${this.records.length >= 1 ? Math.min(...this.records.filter(r => r.isWin).map(r => r.time)) : 0}s`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.themeColors.primaryText)
          Text('æœ€ä½³æˆç»©')
            .fontSize(14)
            .fontColor(this.themeColors.secondaryText)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        
        Column() {
          Text(`${this.records.length > 0 ? Math.round((this.records.filter(r => r.isWin).length / this.records.length) * 100) : 0}%`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.themeColors.primaryText)
          Text('èƒœåˆ©ç‡')
            .fontSize(14)
            .fontColor(this.themeColors.secondaryText)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
      }
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })
      .backgroundColor(this.themeColors.cardBackground)
      .borderRadius(20)
      .border({ width: 1, color: this.themeColors.cardBorder })
      .shadow({
        radius: 6,
        color: this.themeColors.cardShadow,
        offsetX: 2,
        offsetY: 2
      })
      .margin({ left: 20, right: 20, bottom: 20 })
      
      // è®°å½•åˆ—è¡¨
      Column() {
        Text('ğŸ“‹ å†å²è®°å½•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.themeColors.primaryText)
          .alignSelf(ItemAlign.Start)
          .margin({ left: 20, bottom: 10 })
        
        if (this.records.length > 0) {
          Scroll() {
            Column() {
              ForEach(this.records.slice().reverse(), (record: MinesweeperRecord, index: number) => {
                Row() {
                  Text(`${index + 1}`)
                    .fontSize(16)
                    .fontColor(this.themeColors.secondaryText)
                    .width(30)
                  
                  Text(`${record.isWin ? 'ğŸ‰' : 'ğŸ’€'} ${record.time}ç§’`)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.themeColors.primaryText)
                    .layoutWeight(1)
                    .textAlign(TextAlign.Start)
                  
                  Text(this.formatTime(record.timestamp))
                    .fontSize(14)
                    .fontColor(this.themeColors.secondaryText)
                }
                .width('100%')
                .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                .backgroundColor(this.themeColors.cardBackground)
                .borderRadius(12)
                .border({ width: 1, color: this.themeColors.cardBorder })
                .shadow({
                  radius: 4,
                  color: this.themeColors.cardShadow,
                  offsetX: 1,
                  offsetY: 1
                })
                .margin({ left: 20, right: 20, bottom: 10 })
              })
            }
            .width('100%')
          }
          .layoutWeight(1)
        } else {
          Column() {
            Text('æš‚æ— è®°å½•')
              .fontSize(16)
              .fontColor(this.themeColors.secondaryText)
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      }
      .layoutWeight(1)
      
      // åº•éƒ¨ä¿¡æ¯
      Column() {
        Text('ğŸ¯ ç»§ç»­åŠªåŠ›ï¼ŒæŒ‘æˆ˜æ›´é«˜éš¾åº¦ï¼')
          .fontSize(12)
          .fontColor(this.themeColors.tertiaryText)
          .margin({ bottom: 6 })
        
        Text('ğŸ‘¨â€ğŸ’» åˆ¶ä½œäººï¼šNisson_CX')
          .fontSize(11)
          .fontColor(this.themeColors.tertiaryText)
          .margin({ bottom: 20 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeColors.background)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}