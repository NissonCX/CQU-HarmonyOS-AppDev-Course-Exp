import router from '@ohos.router';
import { ThemeManager } from '../model/ThemeManager';
import { ThemeType, ThemeColors } from '../model/Theme';
import { PuzzlePiece } from '../model/PuzzlePiece';

@Entry
@Component
struct SlidingPuzzle {
  @State puzzlePieces: PuzzlePiece[] = []; // æ‹¼å›¾å—æ•°ç»„
  @State moves: number = 0; // ç§»åŠ¨æ¬¡æ•°
  @State currentTime: number = 0; // æ¸¸æˆæ—¶é—´ï¼ˆç§’ï¼‰
  @State isGameFinished: boolean = false; // æ¸¸æˆæ˜¯å¦å®Œæˆ
  @State currentTheme: ThemeType = ThemeManager.getInstance().getCurrentTheme();
  @State themeColors: ThemeColors = ThemeManager.getInstance().getCurrentColors();
  
  private timerId: number = -1; // å®šæ—¶å™¨ID
  private startTime: number = Date.now(); // æ¸¸æˆå¼€å§‹æ—¶é—´
  private readonly gridSize: number = 4; // ç½‘æ ¼å¤§å° (4x4)
  
  // ç»„ä»¶åŠ è½½æ—¶åˆå§‹åŒ–æ¸¸æˆå’Œæ·»åŠ ä¸»é¢˜ç›‘å¬å™¨
  aboutToAppear(): void {
    this.initializeGame();
    
    // æ·»åŠ ä¸»é¢˜ç›‘å¬å™¨
    ThemeManager.getInstance().addThemeChangeListener((theme: ThemeType, colors: ThemeColors) => {
      this.currentTheme = theme;
      this.themeColors = colors;
    });
  }
  
  // ç»„ä»¶é”€æ¯æ—¶æ¸…é™¤å®šæ—¶å™¨å’Œç§»é™¤ä¸»é¢˜ç›‘å¬å™¨
  aboutToDisappear(): void {
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }
  
  // åˆå§‹åŒ–æ¸¸æˆ
  private initializeGame(): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    this.moves = 0;
    this.currentTime = 0;
    this.isGameFinished = false;
    
    // ç”Ÿæˆæ‹¼å›¾å—
    this.generatePuzzle();
    
    // æ‰“ä¹±æ‹¼å›¾
    this.shufflePuzzle();
    
    // å¯åŠ¨è®¡æ—¶å™¨
    this.startTime = Date.now();
    this.timerId = setInterval(() => {
      if (!this.isGameFinished) {
        this.currentTime = Math.floor((Date.now() - this.startTime) / 1000);
      }
    }, 1000);
  }
  
  // ç”Ÿæˆæ‹¼å›¾
  private generatePuzzle(): void {
    this.puzzlePieces = [];
    
    // åˆ›å»ºæ ‡å‡†æ’åˆ—çš„æ‹¼å›¾å—
    for (let row = 0; row < this.gridSize; row++) {
      for (let col = 0; col < this.gridSize; col++) {
        const id = row * this.gridSize + col + 1;
        // æœ€åä¸€ä¸ªå—æ˜¯ç©ºå—
        const isEmpty = (row === this.gridSize - 1 && col === this.gridSize - 1);
        if (!isEmpty) {
          this.puzzlePieces.push(new PuzzlePiece(id, row, col, row, col));
        } else {
          // æ·»åŠ ç©ºå—
          this.puzzlePieces.push(new PuzzlePiece(0, row, col, row, col, true));
        }
      }
    }
  }
  
  // æ‰“ä¹±æ‹¼å›¾
  private shufflePuzzle(): void {
    // è¿›è¡Œ1000æ¬¡éšæœºç§»åŠ¨æ¥æ‰“ä¹±æ‹¼å›¾
    for (let i = 0; i < 1000; i++) {
      const emptyPiece = this.getEmptyPiece();
      const movablePieces = this.getMovablePieces(emptyPiece);
      
      if (movablePieces.length > 0) {
        const randomIndex = Math.floor(Math.random() * movablePieces.length);
        const pieceToMove = movablePieces[randomIndex];
        this.swapPieces(pieceToMove, emptyPiece);
      }
    }
    
    // é‡ç½®ç§»åŠ¨æ¬¡æ•°å’Œæ—¶é—´
    this.moves = 0;
    this.currentTime = 0;
    this.isGameFinished = false;
  }
  
  // è·å–ç©ºå—
  private getEmptyPiece(): PuzzlePiece {
    return this.puzzlePieces.find(piece => piece.isEmpty)!;
  }
  
  // è·å–å¯ä»¥ç§»åŠ¨çš„å—
  private getMovablePieces(emptyPiece: PuzzlePiece): PuzzlePiece[] {
    const movablePieces: PuzzlePiece[] = [];
    
    // æ£€æŸ¥å››ä¸ªæ–¹å‘çš„ç›¸é‚»å—
    const directions = [
      [-1, 0], // ä¸Š
      [1, 0],  // ä¸‹
      [0, -1], // å·¦
      [0, 1]   // å³
    ];
    
    for (const dir of directions) {
      const targetRow = emptyPiece.row + dir[0];
      const targetCol = emptyPiece.col + dir[1];
      
      // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦åœ¨ç½‘æ ¼èŒƒå›´å†…
      if (targetRow >= 0 && targetRow < this.gridSize && targetCol >= 0 && targetCol < this.gridSize) {
        const piece = this.puzzlePieces.find(p => p.row === targetRow && p.col === targetCol);
        if (piece) {
          movablePieces.push(piece);
        }
      }
    }
    
    return movablePieces;
  }
  
  // äº¤æ¢ä¸¤ä¸ªå—çš„ä½ç½®
  private swapPieces(piece1: PuzzlePiece, piece2: PuzzlePiece): void {
    const tempRow = piece1.row;
    const tempCol = piece1.col;
    
    piece1.row = piece2.row;
    piece1.col = piece2.col;
    
    piece2.row = tempRow;
    piece2.col = tempCol;
  }
  
  // å¤„ç†æ‹¼å›¾å—ç‚¹å‡»äº‹ä»¶
  private handlePieceClick(clickedPiece: PuzzlePiece): void {
    if (this.isGameFinished) return;
    
    const emptyPiece = this.getEmptyPiece();
    
    // æ£€æŸ¥ç‚¹å‡»çš„å—æ˜¯å¦å¯ä»¥ç§»åŠ¨ï¼ˆä¸ç©ºå—ç›¸é‚»ï¼‰
    const isAdjacent = 
      (Math.abs(clickedPiece.row - emptyPiece.row) === 1 && clickedPiece.col === emptyPiece.col) ||
      (Math.abs(clickedPiece.col - emptyPiece.col) === 1 && clickedPiece.row === emptyPiece.row);
    
    if (isAdjacent) {
      this.swapPieces(clickedPiece, emptyPiece);
      this.moves++;
      
      // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å®Œæˆ
      if (this.isPuzzleSolved()) {
        this.finishGame();
      }
    }
  }
  
  // æ£€æŸ¥æ‹¼å›¾æ˜¯å¦å·²è§£å†³
  private isPuzzleSolved(): boolean {
    // æ£€æŸ¥é™¤äº†ç©ºå—å¤–çš„æ‰€æœ‰å—æ˜¯å¦éƒ½åœ¨æ­£ç¡®ä½ç½®
    return this.puzzlePieces.every(piece => 
      piece.isEmpty || (piece.row === piece.correctRow && piece.col === piece.correctCol)
    );
  }
  
  // å®Œæˆæ¸¸æˆ
  private finishGame(): void {
    this.isGameFinished = true;
    
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }
  
  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      Row() {
        Column() {
          Text('ğŸ§© æ‹¼å›¾åå®¹é“ ğŸ§ ')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .textAlign(TextAlign.Center)
            .fontColor(this.themeColors.primaryText)
            .margin({ top: 20 })

          Text('ç§»åŠ¨æ–¹å—ä½¿å…¶æŒ‰æ•°å­—é¡ºåºæ’åˆ—')
            .fontSize(14)
            .fontColor(this.themeColors.secondaryText)
            .margin({ top: 6 })

          // æ¸¸æˆä¿¡æ¯æ˜¾ç¤º
          Row() {
            // æ­¥æ•°æ˜¾ç¤º
            Row() {
              Text('ğŸ‘£')
                .fontSize(16)
                .fontColor(this.themeColors.buttonText)
              Text(`${this.moves}`)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor(this.themeColors.buttonText)
                .margin({ left: 4 })
            }
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor(this.themeColors.cardBackground)
            .borderRadius(12)
            .border({ width: 1, color: this.themeColors.cardBorder })
            .shadow({
              radius: 6,
              color: this.themeColors.cardShadow,
              offsetX: 2,
              offsetY: 2
            })
            .margin({ right: 12 })

            // æ—¶é—´æ˜¾ç¤º
            Row() {
              Text('â±')
                .fontSize(16)
                .fontColor(this.themeColors.buttonText)
              Text(`${this.formatTime(this.currentTime)}`)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor(this.themeColors.buttonText)
                .margin({ left: 4 })
            }
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .backgroundColor(this.themeColors.cardBackground)
            .borderRadius(12)
            .border({ width: 1, color: this.themeColors.cardBorder })
            .shadow({
              radius: 6,
              color: this.themeColors.cardShadow,
              offsetX: 2,
              offsetY: 2
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ top: 12 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
        
        // è¿”å›æŒ‰é’®
        Button('â†')
          .width(40)
          .height(40)
          .backgroundColor(this.themeColors.buttonBackground)
          .fontColor(this.themeColors.buttonText)
          .borderRadius(20)
          .border({ width: 1, color: this.themeColors.buttonBorder })
          .shadow({
            radius: 4,
            color: this.themeColors.cardShadow,
            offsetX: 1,
            offsetY: 1
          })
          .margin({ top: 20, right: 20 })
          .onClick(() => {
            router.back();
          })
      }
      .width('100%')
      .margin({ bottom: 20 })

      // æ¸¸æˆä¸»åŒºåŸŸ
      Column() {
        // æ‹¼å›¾ç½‘æ ¼
        Grid() {
          ForEach(this.puzzlePieces, (piece: PuzzlePiece) => {
            GridItem() {
              Stack() {
                // æ–¹å—èƒŒæ™¯
                Rect()
                  .width('100%')
                  .height('100%')
                  .fill(piece.isEmpty ? 
                    this.themeColors.background : 
                    (piece.isCorrectPosition() ? 
                      this.themeColors.successColor : 
                      this.themeColors.gameCellBackground))
                  .strokeWidth(1)
                  .stroke(this.themeColors.gameCellBorder)
                  .radius(8)
                  .shadow({
                    radius: 4,
                    color: this.themeColors.cardShadow,
                    offsetX: 2,
                    offsetY: 2
                  })

                // æ–¹å—å†…å®¹
                Text(piece.getDisplayText())
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(piece.isEmpty ? 
                    this.themeColors.background : 
                    (piece.isCorrectPosition() ? 
                      '#FFFFFF' : 
                      this.themeColors.buttonText))
                  .textAlign(TextAlign.Center)
              }
              .width('100%')
              .height('100%')
              .onClick(() => this.handlePieceClick(piece))
            }
          }, (item: PuzzlePiece) => item.id.toString())
        }
        .width(300)
        .height(300)
        .columnsTemplate('1fr 1fr 1fr 1fr')
        .rowsTemplate('1fr 1fr 1fr 1fr')
        .columnsGap(4)
        .rowsGap(4)
        .borderRadius(8)
        .margin({ top: 20 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .layoutWeight(1)

      // æ§åˆ¶æŒ‰é’®åŒºåŸŸ
      Column({ space: 16 }) {
        // é‡æ–°å¼€å§‹æŒ‰é’®
        Button('ğŸ”„ é‡æ–°å¼€å§‹')
          .fontColor(this.themeColors.buttonText)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width(200)
          .height(50)
          .backgroundColor(this.themeColors.buttonBackground)
          .borderRadius(14)
          .border({ width: 1, color: this.themeColors.buttonBorder })
          .shadow({
            radius: 8,
            color: this.themeColors.cardShadow,
            offsetX: 2,
            offsetY: 2
          })
          .onClick(() => this.initializeGame())

        // æ¸¸æˆå®Œæˆæç¤º
        if (this.isGameFinished) {
          Text('ğŸ‰ æ­å–œå®Œæˆæ‹¼å›¾ï¼ ğŸ‰')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.themeColors.successColor)
            .textAlign(TextAlign.Center)
            .margin({ top: 10 })
          
          Text(`ç”¨æ—¶: ${this.formatTime(this.currentTime)}  æ­¥æ•°: ${this.moves}`)
            .fontSize(14)
            .fontColor(this.themeColors.secondaryText)
            .textAlign(TextAlign.Center)
            .margin({ top: 4 })
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .margin({ bottom: 30 })

      // åº•éƒ¨ä¿¡æ¯åŒºåŸŸ
      Column() {
        Text('ğŸ¯ æ‹¼å›¾åå®¹é“è€ƒéªŒä½ çš„é€»è¾‘æ€ç»´èƒ½åŠ›')
          .fontSize(12)
          .fontColor(this.themeColors.tertiaryText)
          .margin({ bottom: 6 })

        Text('ğŸ§© é€»è¾‘æ¨ç† Â· â±ï¸ æŒ‘æˆ˜é€Ÿåº¦')
          .fontSize(11)
          .fontColor(this.themeColors.tertiaryText)
          .margin({ bottom: 6 })

        Text('ğŸ‘¨â€ğŸ’» åˆ¶ä½œäººï¼šNisson_CX')
          .fontSize(11)
          .fontColor(this.themeColors.tertiaryText)
          .margin({ bottom: 20 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeColors.background)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}