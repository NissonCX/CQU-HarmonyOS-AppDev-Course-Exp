// Minesweeper.ets
import { promptAction } from '@kit.ArkUI'; // å¯¼å…¥ç”¨äºæ˜¾ç¤ºå¯¹è¯æ¡†çš„å·¥å…·
import router from '@ohos.router';
import { Cell } from '../model/Cell'

// å®šä¹‰æ‰«é›·æ¸¸æˆç»„ä»¶
@Entry
  // ä½¿ç”¨@Entryè£…é¥°å™¨å£°æ˜è¿™æ˜¯ä¸€ä¸ªå…¥å£ç»„ä»¶
@Component
  // ä½¿ç”¨@Componentè£…é¥°å™¨å£°æ˜è¿™æ˜¯ä¸€ä¸ªç»„ä»¶
struct MineSweeper {
  @State private gameBoard: Cell[][] = []; // æ¸¸æˆé¢æ¿æ•°æ®
  @State private mineCount: number = 10; // åœ°é›·æ€»æ•°
  @State private revealedCells: Set<string> = new Set(); // å·²ç»æ­ç¤ºçš„æ–¹å—é›†åˆ
  @State private flaggedCells: Set<string> = new Set(); // æ ‡è®°ä¸ºåœ°é›·çš„æ–¹å—é›†åˆ
  @State private cellSize: number = 60; // ç¼©å°æ–¹å—å¤§å°
  @State private cellMargin: number = 1; // ç¼©å°æ–¹å—è¾¹è·
  @State private currentTime: number = 0; // å½“å‰æ¸¸æˆæ—¶é—´ï¼ˆç§’ï¼‰
  @State private isFlagMode: boolean = false; // æ˜¯å¦ä¸ºæ ‡è®°æ¨¡å¼
  private startTime: number = Date.now(); // æ¸¸æˆå¼€å§‹æ—¶é—´
  @State private isGameOver: boolean = false; // æ¸¸æˆç»“æŸæ ‡å¿—
  private timerId: number = -1; // å®šæ—¶å™¨ID

  // å½“ç»„ä»¶å³å°†æ˜¾ç¤ºæ—¶è°ƒç”¨æ­¤æ–¹æ³•
  aboutToAppear(): void {
    this.initializeGame(); // åˆå§‹åŒ–æ¸¸æˆ
  }

  // ç»„ä»¶é”€æ¯æ—¶æ¸…é™¤å®šæ—¶å™¨
  aboutToDisappear(): void {
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }

  // åˆå§‹åŒ–æ¸¸æˆ
  private initializeGame() {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }

    this.isGameOver = false; // è®¾ç½®æ¸¸æˆæœªç»“æŸ
    this.isFlagMode = false; // é‡ç½®ä¸ºæ­å¼€æ¨¡å¼
    this.startTime = Date.now(); // é‡ç½®æ¸¸æˆå¼€å§‹æ—¶é—´
    this.currentTime = 0; // é‡ç½®å½“å‰æ—¶é—´
    this.revealedCells.clear(); // æ¸…ç©ºå·²æ­ç¤ºçš„æ–¹å—é›†åˆ
    this.flaggedCells.clear(); // æ¸…ç©ºæ ‡è®°ä¸ºåœ°é›·çš„æ–¹å—é›†åˆ

    // å¯åŠ¨è®¡æ—¶å™¨
    this.timerId = setInterval(() => {
      if (!this.isGameOver) {
        this.currentTime = Math.floor((Date.now() - this.startTime) / 1000);
      }
    }, 1000);

    this.generateBoard(); // ç”Ÿæˆæ–°çš„æ¸¸æˆé¢æ¿
  }

  // åˆ‡æ¢æ“ä½œæ¨¡å¼
  private toggleMode() {
    if (this.isGameOver) return;
    this.isFlagMode = !this.isFlagMode;
  }

  // ç”Ÿæˆæ¸¸æˆé¢æ¿
  private generateBoard() {
    this.gameBoard = []; // æ¸…ç©ºæ¸¸æˆé¢æ¿
    for (let i = 0; i < 10; i++) { // å¾ªç¯åˆ›å»º10è¡Œ
      this.gameBoard.push([]); // æ¯è¡Œåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
      for (let j = 0; j < 10; j++) { // å¾ªç¯åˆ›å»º10åˆ—
        this.gameBoard[i].push(new Cell(i, j)); // ä¸ºæ¯ä¸ªä½ç½®åˆ›å»ºä¸€ä¸ªæ–°æ–¹å—
      }
    }
    this.placeMines(); // éšæœºæ”¾ç½®åœ°é›·
    this.calculateNumbers(); // è®¡ç®—æ¯ä¸ªæ–¹å—å‘¨å›´çš„åœ°é›·æ•°é‡
  }

  // éšæœºæ”¾ç½®åœ°é›·
  private placeMines() {
    let placed = 0; // å·²æ”¾ç½®çš„åœ°é›·æ•°é‡
    while (placed < this.mineCount) { // å½“å·²æ”¾ç½®çš„åœ°é›·å°‘äºè®¾å®šæ•°é‡æ—¶ç»§ç»­æ”¾ç½®
      let x = Math.floor(Math.random() * 10); // éšæœºé€‰æ‹©ä¸€è¡Œ
      let y = Math.floor(Math.random() * 10); // éšæœºé€‰æ‹©ä¸€åˆ—
      if (!this.gameBoard[x][y].hasMine) { // å¦‚æœè¯¥ä½ç½®è¿˜æ²¡æœ‰åœ°é›·
        this.gameBoard[x][y].hasMine = true; // åœ¨è¯¥ä½ç½®æ”¾ç½®åœ°é›·
        placed++; // åœ°é›·è®¡æ•°åŠ 1
      }
    }
  }

  // è®¡ç®—æ¯ä¸ªæ–¹å—å‘¨å›´çš„åœ°é›·æ•°é‡
  private calculateNumbers() {
    for (let i = 0; i < 10; i++) { // éå†æ¯ä¸€è¡Œ
      for (let j = 0; j < 10; j++) { // éå†æ¯ä¸€åˆ—
        if (!this.gameBoard[i][j].hasMine) { // å¦‚æœå½“å‰æ–¹å—ä¸æ˜¯åœ°é›·
          this.gameBoard[i][j].neighborMines = this.countNeighborMines(i, j); // è®¡ç®—å¹¶è®¾ç½®å‘¨å›´åœ°é›·æ•°é‡
          this.gameBoard[i][j].value = this.gameBoard[i][j].neighborMines.toString(); // å°†æ•°é‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²
        } else {
          this.gameBoard[i][j].value = 'ğŸ’£'; // å¦‚æœæ˜¯åœ°é›·ï¼Œåˆ™è®¾ç½®å€¼ä¸ºç‚¸å¼¹emoji
        }
      }
    }
  }

  // è®¡ç®—ç»™å®šåæ ‡å‘¨å›´åœ°é›·çš„æ•°é‡
  private countNeighborMines(row: number, col: number): number {
    let count = 0; // å‘¨å›´åœ°é›·è®¡æ•°
    for (let dx = -1; dx <= 1; dx++) { // éå†ä¸Šä¸‹å·¦å³åŠå¯¹è§’çº¿æ–¹å‘
      for (let dy = -1; dy <= 1; dy++) {
        if (dx === 0 && dy === 0) { // è·³è¿‡å½“å‰ä½ç½®
          continue;
        }
        let newRow = row + dx, newCol = col + dy; // æ–°çš„è¡Œåˆ—åæ ‡
        if (newRow >= 0 && newRow < 10 && newCol >= 0 && newCol < 10 &&
        this.gameBoard[newRow][newCol].hasMine) { // å¦‚æœæ–°ä½ç½®æœ‰æ•ˆä¸”æ˜¯åœ°é›·
          count++; // åœ°é›·è®¡æ•°åŠ 1
        }
      }
    }
    return count; // è¿”å›åœ°é›·è®¡æ•°
  }

  // æ­ç¤ºæ–¹å—
  private revealCell(row: number, col: number) {
    if (this.isGameOver || this.revealedCells.has(`${row},${col}`)) { // å¦‚æœæ¸¸æˆç»“æŸæˆ–è€…è¯¥æ–¹å—å·²ç»è¢«æ­ç¤º
      return; // ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    }
    const key = `${row},${col}`; // åˆ›å»ºæ–¹å—å”¯ä¸€æ ‡è¯†
    this.revealedCells.add(key); // æ·»åŠ åˆ°å·²æ­ç¤ºçš„æ–¹å—é›†åˆ
    if (this.gameBoard[row][col].hasMine) { // å¦‚æœæ­ç¤ºçš„æ–¹å—æ˜¯åœ°é›·
      this.showGameOverDialog(); // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¯¹è¯æ¡†
    } else {
      if (this.gameBoard[row][col].neighborMines === 0) { // å¦‚æœæ­ç¤ºçš„æ–¹å—å‘¨å›´æ²¡æœ‰åœ°é›·
        for (let dx = -1; dx <= 1; dx++) { // è‡ªåŠ¨æ­ç¤ºå‘¨å›´æ‰€æœ‰æ–¹å—
          for (let dy = -1; dy <= 1; dy++) {
            if (dx === 0 && dy === 0) { // è·³è¿‡å½“å‰ä½ç½®
              continue;
            }
            let newRow = row + dx, newCol = col + dy;
            if (newRow >= 0 && newRow < 10 && newCol >= 0 && newCol < 10) { // å¦‚æœæ–°ä½ç½®æœ‰æ•ˆ
              this.revealCell(newRow, newCol); // é€’å½’æ­ç¤ºç›¸é‚»æ–¹å—
            }
          }
        }
      }
    }
    if (this.isVictory()) { // å¦‚æœæ¸¸æˆèƒœåˆ©
      this.showVictoryDialog(); // æ˜¾ç¤ºèƒœåˆ©å¯¹è¯æ¡†
    }
  }

  // æ ‡è®°æ–¹å—
  private flagCell(row: number, col: number) {
    if (this.isGameOver || this.revealedCells.has(`${row},${col}`)) {
      return;
    }

    const cell = this.gameBoard[row][col];
    cell.isFlag = !cell.isFlag;
  }

  // å¤„ç†æ–¹å—ç‚¹å‡»äº‹ä»¶
  private handleCellClick(row: number, col: number) {
    if (this.isFlagMode) {
      this.flagCell(row, col);
    } else {
      this.revealCell(row, col);
    }
  }

  // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¯¹è¯æ¡†
  private showGameOverDialog() {
    this.isGameOver = true; // è®¾ç½®æ¸¸æˆç»“æŸ
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }

    promptAction.showDialog({
      // æ˜¾ç¤ºå¯¹è¯æ¡†
      title: 'æ¸¸æˆç»“æŸ: æ¸¸æˆå¤±è´¥ï¼', // å¯¹è¯æ¡†æ ‡é¢˜
      buttons: [{ text: 'é‡æ–°å¼€å§‹', color: '#007DFF' }] // å¯¹è¯æ¡†æŒ‰é’®
    }).then(() => { // ç‚¹å‡»æŒ‰é’®åæ‰§è¡Œ
      this.initializeGame(); // é‡æ–°å¼€å§‹æ¸¸æˆ
    });
  }

  // æ˜¾ç¤ºèƒœåˆ©å¯¹è¯æ¡†
  private showVictoryDialog() {
    this.isGameOver = true; // è®¾ç½®æ¸¸æˆç»“æŸ
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }

    promptAction.showDialog({
      // æ˜¾ç¤ºå¯¹è¯æ¡†
      title: 'æ­å–œä½ ï¼Œæ¸¸æˆèƒœåˆ©ï¼', // å¯¹è¯æ¡†æ ‡é¢˜
      message: `ç”¨æ—¶ï¼š${((Date.now() - this.startTime) / 1000).toFixed(3)}ç§’`, // å¯¹è¯æ¡†æ¶ˆæ¯
      buttons: [{ text: 'é‡æ–°å¼€å§‹', color: '#007DFF' }] // å¯¹è¯æ¡†æŒ‰é’®
    }).then(() => { // ç‚¹å‡»æŒ‰é’®åæ‰§è¡Œ
      this.initializeGame(); // é‡æ–°å¼€å§‹æ¸¸æˆ
    });
  }

  // åˆ¤æ–­æ¸¸æˆæ˜¯å¦èƒœåˆ©
  private isVictory(): boolean {
    let revealedNonMineCount = 0; // éåœ°é›·æ–¹å—çš„æ­ç¤ºæ•°é‡
    for (let i = 0; i < this.gameBoard.length; i++) { // éå†æ¯ä¸€è¡Œ
      for (let j = 0; j < this.gameBoard[i].length; j++) { // éå†æ¯ä¸€åˆ—
        if (this.revealedCells.has(`${i},${j}`)) { // å¦‚æœæ–¹å—å·²è¢«æ­ç¤º
          revealedNonMineCount++; // éåœ°é›·æ–¹å—çš„æ­ç¤ºæ•°é‡åŠ 1
        }
      }
    }
    return revealedNonMineCount == 90; // å¦‚æœéåœ°é›·æ–¹å—å…¨éƒ¨æ­ç¤ºï¼Œåˆ™æ¸¸æˆèƒœåˆ©
  }

  // å†³å®šæ˜¯å¦æ˜¾ç¤ºæ–¹å—å€¼
  private isShowValue(cell: Cell): string {
    if (this.isGameOver) { // å¦‚æœæ¸¸æˆç»“æŸ
      return cell.value === '0' ? '' : cell.value; // æ˜¾ç¤ºæ–¹å—å€¼ï¼Œé™¤éæ˜¯0
    } else {
      if (this.revealedCells.has(`${cell.row},${cell.column}`)) { // å¦‚æœæ–¹å—å·²è¢«æ­ç¤º
        return cell.value === '0' ? '' : cell.value; // æ˜¾ç¤ºæ–¹å—å€¼ï¼Œé™¤éæ˜¯0
      } else {
        return ''; // å¦åˆ™ä¸æ˜¾ç¤ºå€¼
      }
    }
  }

  // æ„å»ºç”¨æˆ·ç•Œé¢
  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      Column() {
        Text(' ğŸš©æ‰«é›·ğŸ’¥ ')
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .textAlign(TextAlign.Center)
          .fontColor('#1a1a1a')
          .margin({ top: 20 })

        Text('ç‚¹å‡»æ­å¼€æ¨¡å¼åˆ‡æ¢ä¸ºæ ‡è®°æ¨¡å¼')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ top: 6 })

        // æ—¶é—´æ˜¾ç¤º
        Row() {
          Text('â±')
            .fontSize(18)
          Text(`${this.currentTime.toString().padStart(3, '0')}s`)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .margin({ left: 10 })
        }
        .padding({ left: 20, right: 20, top: 10, bottom: 10 })
        .backgroundColor('#FFFFFF')
        .borderRadius(18)
        .shadow({
          radius: 6,
          color: '#333333',
          offsetX: 2,
          offsetY: 2
        })
        .margin({ top: 15, bottom: 5 })
        .alignSelf(ItemAlign.Center)
      }
      .margin({ top: 20 })

      // æ¸¸æˆä¸»åŒºåŸŸ
      Column() {
        // æ¸¸æˆé¢æ¿
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(this.gameBoard, (row: Cell[], rowIndex: number) => {
            ForEach(row, (cell: Cell, colIndex: number) => {
              Stack() {
                // æ ¼å­èƒŒæ™¯
                Rect()
                  .width(`${this.cellSize}lpx`)
                  .height(`${this.cellSize}lpx`)
                  .margin(`${this.cellMargin}lpx`)
                  .fill(this.revealedCells.has(`${rowIndex},${colIndex}`) ?
                    (this.isShowValue(cell) === 'ğŸ’£' ? '#FF4D4D' : '#FFFFFF') : '#5CACEE')
                  .strokeWidth(1)
                  .stroke('#4A90E2')
                  .radius(6)
                  .shadow({
                    radius: 3,
                    color: '#00000020',
                    offsetX: 1,
                    offsetY: 1
                  })

                // æ ¼å­å†…å®¹
                Text(this.isShowValue(cell))
                  .width(`${this.cellSize}lpx`)
                  .height(`${this.cellSize}lpx`)
                  .margin(`${this.cellMargin}lpx`)
                  .fontSize(`${this.cellSize / 2 + 2}lpx`)
                  .textAlign(TextAlign.Center)
                  .fontColor(this.revealedCells.has(`${rowIndex},${colIndex}`) ?
                    (this.isShowValue(cell) === 'ğŸ’£' ? '#FFFFFF' : '#333333') :
                    '#FFFFFF')
                  .fontWeight(FontWeight.Bold)

                // æ ‡è®°æ——å¸œ
                Text(`${cell.isFlag && !this.revealedCells.has(`${rowIndex},${colIndex}`) ? 'ğŸš©' : ''}`)
                  .width(`${this.cellSize}lpx`)
                  .height(`${this.cellSize}lpx`)
                  .margin(`${this.cellMargin}lpx`)
                  .fontSize(`${this.cellSize / 2 + 2}lpx`)
                  .textAlign(TextAlign.Center)
                  .fontColor('#E53935')
                  .visibility(cell.isFlag && !this.revealedCells.has(`${rowIndex},${colIndex}`) && !this.isGameOver ?
                  Visibility.Visible : Visibility.None)
              }
              .onClick(() => this.handleCellClick(rowIndex, colIndex))
            });
          });
        }
        .width(`${(this.cellSize + this.cellMargin * 2) * 10}lpx`)
        .margin({ top: 15 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)
      .layoutWeight(1)

      // æ§åˆ¶æŒ‰é’®åŒºåŸŸ
      Column() {
        // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
        Button(`${this.isFlagMode ? ' æ ‡è®°æ¨¡å¼ğŸš©' : ' æ­å¼€æ¨¡å¼ğŸ‘†'}`)
          .fontColor(Color.Black)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .width(200)
          .height(50)
          .backgroundColor('#FFFFFF')
          .borderRadius(14)
          .shadow({
            radius: 6,
            color: '#333333',
            offsetX: 2,
            offsetY: 2
          })
          .onClick(() => this.toggleMode())
          .margin({ top: 10, bottom: 10 })

        // é‡æ–°å¼€å§‹æŒ‰é’®
        Button('é‡æ–°å¼€å§‹ğŸ”ƒ')
          .fontColor(Color.Black)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .width(200)
          .height(50)
          .backgroundColor('#FFFFFF')
          .borderRadius(14)
          .shadow({
            radius: 6,
            color: '#333333',
            offsetX: 2,
            offsetY: 2
          })
          .margin({ bottom: 10 })
          .onClick(() => {
            promptAction.showDialog({
              title: 'ç¡®è®¤é‡æ–°å¼€å§‹',
              message: 'ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿå½“å‰æ¸¸æˆè¿›åº¦å°†ä¼šä¸¢å¤±ã€‚',
              buttons: [
                {
                  text: 'ç¡®å®š',
                  color: '#007DFF'
                },
                {
                  text: 'å–æ¶ˆ',
                  color: '#999999'
                }
              ]
            }).then((result) => {
              if (result.index == 0) {
                // ç”¨æˆ·ç‚¹å‡»"ç¡®å®š"
                this.initializeGame();
              }
              // ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ"æˆ–å…¶ä»–æƒ…å†µï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            });
          })

      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)

      // åº•éƒ¨ä¿¡æ¯åŒºåŸŸ
      Column() {
        Text('æ‰«é›·æ˜¯ä¸€ä¸ªç»å…¸çš„æ¸¸æˆï¼Œè€ƒéªŒä½ çš„é€»è¾‘æ¨ç†èƒ½åŠ›')
          .fontSize(12)
          .fontColor('#999999')
          .margin({ bottom: 8 })

        Text('ğŸ¯ é€»è¾‘æ¨ç† | â±ï¸ æŒ‘æˆ˜é€Ÿåº¦')
          .fontSize(11)
          .fontColor('#bbbbbb')
          .margin({ bottom: 4 })

        Text('åˆ¶ä½œäººï¼šNisson_CX')
          .fontSize(11)
          .fontColor('#cccccc')
          .margin({ bottom: 15 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f0f0f0')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}
